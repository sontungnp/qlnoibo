<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>AG Grid TreeView - Auto Generated Tree Data</title>

    <!-- AG Grid Community -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css"
    />

    <style>
      html,
      body,
      #myGrid {
        height: 100%;
        width: 100%;
        margin: 0;
      }

      .tree-cell {
        display: flex;
        align-items: center;
      }

      .tree-indent {
        display: inline-block;
      }

      .tree-toggle {
        cursor: pointer;
        font-weight: bold;
        margin-right: 6px;
        user-select: none;
        color: #0066cc;
        width: 16px;
        text-align: center;
      }

      .tree-icon {
        margin-right: 6px;
      }

      .icon-company {
        color: #2d7dd2;
      }
      .icon-department {
        color: #21a179;
      }
      .icon-team {
        color: #e0a800;
      }
      .icon-employee {
        color: #555;
      }
    </style>
  </head>
  <body>
    <div id="myGrid" class="ag-theme-alpine"></div>

    <script>
      // üß© Sinh d·ªØ li·ªáu c√¢y ƒë·ªông
      function generateTreeData(levels = 3, childrenPerNode = 3, startId = 1) {
        let idCounter = startId

        function createNode(level, parentId = null, type = 'Company') {
          const types = ['Company', 'Department', 'Team', 'Employee']
          const node = {
            id: idCounter++,
            parent: parentId,
            name: `${type}-${idCounter}`,
            type: types[level - 1] || 'Employee',
            age: 20 + Math.floor(Math.random() * 30),
            address: `S·ªë ${Math.floor(
              Math.random() * 200
            )} ƒê∆∞·ªùng ${String.fromCharCode(
              65 + Math.floor(Math.random() * 26)
            )}`,
            expanded: level < levels // m·∫∑c ƒë·ªãnh m·ªü tr·ª´ t·∫ßng cu·ªëi
          }

          if (level < levels) {
            for (let i = 0; i < childrenPerNode; i++) {
              createNode(level + 1, node.id, types[level])
            }
          }

          flatData.push(node)
          return node
        }

        const flatData = []
        for (let i = 0; i < childrenPerNode; i++) {
          createNode(1, null)
        }

        return flatData
      }

      // üîπ Build danh s√°ch hi·ªÉn th·ªã d·ª±a tr√™n c√°c node ƒëang m·ªü
      function buildVisibleRows(data, parent = null, level = 0) {
        const rows = []
        data
          .filter((item) => item.parent === parent)
          .forEach((item) => {
            rows.push({ ...item, level })
            if (item.expanded) {
              rows.push(...buildVisibleRows(data, item.id, level + 1))
            }
          })
        return rows
      }

      let gridApi
      let fullData = generateTreeData(2, 2) // 3 c·∫•p, m·ªói node c√≥ 3 con

      console.log('fullData', fullData)

      console.log('buildVisibleRows(fullData)', buildVisibleRows(fullData))

      // üîπ Toggle node
      function toggleNode(id) {
        const node = fullData.find((n) => n.id === id)
        if (!node) return
        node.expanded = !node.expanded
        const newVisible = buildVisibleRows(fullData)
        if (gridApi) gridApi.setGridOption('rowData', newVisible)
      }

      // üîπ Icon hi·ªÉn th·ªã
      function getIcon(type) {
        switch (type) {
          case 'Company':
            return 'üè¢'
          case 'Department':
            return 'üè¨'
          case 'Team':
            return 'üë•'
          case 'Employee':
            return 'üë§'
          default:
            return 'üìÅ'
        }
      }

      // üîπ Renderer cho tree
      function treeRenderer(params) {
        const eDiv = document.createElement('div')
        eDiv.classList.add('tree-cell')

        // indent theo c·∫•p
        const indent = document.createElement('span')
        indent.classList.add('tree-indent')
        indent.style.width = params.data.level * 20 + 'px'
        eDiv.appendChild(indent)

        const hasChildren = fullData.some((d) => d.parent === params.data.id)

        const toggle = document.createElement('span')
        toggle.classList.add('tree-toggle')
        if (hasChildren) {
          toggle.textContent = params.data.expanded ? '‚àí' : '+'
          toggle.onclick = () => toggleNode(params.data.id)
        } else {
          toggle.textContent = ''
        }
        eDiv.appendChild(toggle)

        const nodeIcon = document.createElement('span')
        nodeIcon.classList.add(
          'tree-icon',
          `icon-${params.data.type.toLowerCase()}`
        )
        nodeIcon.textContent = getIcon(params.data.type)
        eDiv.appendChild(nodeIcon)

        const label = document.createElement('span')
        label.textContent = params.value
        eDiv.appendChild(label)

        return eDiv
      }

      // üîπ C·∫•u h√¨nh AG Grid
      const gridOptions = {
        theme: 'legacy',
        columnDefs: [
          {
            field: 'name',
            headerName: 'T√™n / C·∫•u tr√∫c t·ªï ch·ª©c',
            flex: 2,
            cellRenderer: treeRenderer
          },
          { field: 'type', headerName: 'Lo·∫°i', flex: 1 },
          { field: 'age', headerName: 'Tu·ªïi', flex: 1 },
          { field: 'address', headerName: 'ƒê·ªãa ch·ªâ', flex: 2 }
        ],
        defaultColDef: {
          resizable: true,
          sortable: true
        },
        rowData: buildVisibleRows(fullData),
        animateRows: true
      }

      const gridDiv = document.querySelector('#myGrid')
      gridApi = agGrid.createGrid(gridDiv, gridOptions)
    </script>
  </body>
</html>
