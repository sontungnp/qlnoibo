<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>AG Grid TreeView - Copyable</title>

    <!-- AG Grid Community (v34.x) -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css"
    />

    <style>
      body {
        margin: 20px;
        font-family: sans-serif;
      }
      #gridContainer {
        height: 600px;
        width: 100%;
      }
      .toolbar {
        margin-bottom: 10px;
      }
      input,
      button {
        padding: 6px 10px;
        margin-right: 10px;
      }
      .tree-indent {
        display: inline-block;
        width: 15px;
      }
      .toggle-btn {
        cursor: pointer;
        font-weight: bold;
        color: #0078d7;
      }
    </style>
  </head>
  <body>
    <h2>AG Grid TreeView (Community Edition)</h2>

    <div class="toolbar">
      ğŸ”
      <input type="text" id="globalSearch" placeholder="TÃ¬m kiáº¿m toÃ n bá»™..." />
      <button id="exportExcel">ğŸ“¤ Export CSV</button>
      <button id="copyRow">ğŸ“‹ Copy dÃ²ng Ä‘Æ°á»£c chá»n</button>
    </div>

    <div id="gridContainer" class="ag-theme-quartz" style="theme: legacy"></div>

    <script>
      // ======================
      // 1ï¸âƒ£ Dá»¯ liá»‡u máº«u
      // ======================
      const fullData = [
        { tree_lv1: 'fpt', tree_lv2: 'fis', tree_lv3: 'fis1', name: 'CNTT' },
        { tree_lv1: 'fpt', tree_lv2: 'fis', tree_lv3: 'fis2', name: 'Backend' },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis3',
          name: 'Frontend'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis4',
          name: 'Tráº§n Thá»‹ B'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft1',
          name: 'Pháº¡m VÄƒn C'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft2',
          name: 'Kinh doanh'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft3',
          name: 'Sales'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft4',
          name: 'Marketing'
        }
      ]

      // ======================
      // 2ï¸âƒ£ Build dá»¯ liá»‡u Tree
      // ======================
      function buildTree(data) {
        const tree = []
        const map = {}

        data.forEach((row) => {
          const key1 = row.tree_lv1
          const key2 = row.tree_lv2
          const key3 = row.tree_lv3

          if (!map[key1]) {
            map[key1] = {
              id: key1,
              name: key1,
              level: 1,
              expanded: true,
              children: []
            }
            tree.push(map[key1])
          }

          if (!map[key1 + '/' + key2]) {
            const node2 = {
              id: key1 + '/' + key2,
              name: key2,
              level: 2,
              expanded: true,
              children: []
            }
            map[key1].children.push(node2)
            map[key1 + '/' + key2] = node2
          }

          const node3 = {
            id: key1 + '/' + key2 + '/' + key3,
            name: row.name,
            level: 3,
            tree_lv1: key1,
            tree_lv2: key2,
            tree_lv3: key3,
            leaf: true
          }
          map[key1 + '/' + key2].children.push(node3)
        })

        return tree
      }

      const nestedData = buildTree(fullData)

      console.log('fullData', fullData)
      console.log('nestedData', nestedData)

      // ======================
      // 3ï¸âƒ£ Flatten tree
      // ======================
      function flattenTree(nodes, parentExpanded = true, parentPath = '') {
        const rows = []
        for (const node of nodes) {
          node.path = parentPath ? parentPath + '/' + node.id : node.id
          node.visible = parentExpanded

          rows.push(node)
          if (node.children && node.expanded) {
            rows.push(...flattenTree(node.children, node.expanded, node.path))
          }
        }
        return rows
      }

      let flatData = flattenTree(nestedData)

      console.log('flatData', flatData)

      // ======================
      // 4ï¸âƒ£ Cá»™t hiá»ƒn thá»‹
      // ======================
      const columnDefs = [
        {
          headerName: 'Cáº¥u trÃºc cÃ¢y',
          field: 'name',
          flex: 2,
          cellRenderer: (params) => {
            const node = params.data
            const indent = '<span class="tree-indent">'.repeat(node.level - 1)
            if (node.leaf) {
              return indent + 'ğŸ“„ ' + node.name
            } else {
              const symbol = node.expanded ? 'â–' : 'â•'
              return (
                indent +
                `<span class="toggle-btn" data-id="${node.id}">${symbol}</span> ğŸ“ ` +
                node.name
              )
            }
          }
        },
        {
          field: 'tree_lv1',
          headerName: 'Level 1',
          filter: 'agTextColumnFilter'
        },
        {
          field: 'tree_lv2',
          headerName: 'Level 2',
          filter: 'agTextColumnFilter'
        },
        {
          field: 'tree_lv3',
          headerName: 'Level 3',
          filter: 'agTextColumnFilter'
        }
      ]

      // ======================
      // 5ï¸âƒ£ Cáº¥u hÃ¬nh AG Grid
      // ======================
      const gridOptions = {
        columnDefs,
        rowData: flatData,
        defaultColDef: {
          filter: true,
          sortable: true,
          resizable: true
        },
        rowSelection: {
          mode: 'multiRow',
          checkboxes: true
        },
        suppressRowHoverHighlight: false,
        onCellClicked: (params) => {
          const el = params.event.target
          if (el.classList.contains('toggle-btn')) {
            toggleNode(el.dataset.id)
          }
        }
      }

      const eGridDiv = document.getElementById('gridContainer')
      const gridApi = agGrid.createGrid(eGridDiv, gridOptions)

      // ======================
      // 6ï¸âƒ£ Toggle tree node
      // ======================
      function toggleNode(nodeId) {
        function recursiveToggle(nodes) {
          for (const n of nodes) {
            if (n.id === nodeId) {
              n.expanded = !n.expanded
            }
            if (n.children) recursiveToggle(n.children)
          }
        }
        recursiveToggle(nestedData)
        gridApi.setGridOption('rowData', flattenTree(nestedData))
      }

      // ======================
      // 7ï¸âƒ£ Full text search
      // ======================
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        gridApi.setGridOption('quickFilterText', e.target.value)
      })

      // ======================
      // 8ï¸âƒ£ Export CSV
      // ======================
      document.getElementById('exportExcel').addEventListener('click', () => {
        const rows = gridApi.getGridOption('rowData')
        const csv = [
          ['Name', 'Level 1', 'Level 2', 'Level 3'],
          ...rows.map((r) => [
            r.name || '',
            r.tree_lv1 || '',
            r.tree_lv2 || '',
            r.tree_lv3 || ''
          ])
        ]
          .map((r) => r.join(','))
          .join('\n')

        const blob = new Blob([csv], { type: 'text/csv' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'tree_export.csv'
        a.click()
        URL.revokeObjectURL(url)
      })

      // ======================
      // 9ï¸âƒ£ Copy dÃ²ng
      // ======================
      document.getElementById('copyRow').addEventListener('click', () => {
        const selected = gridApi.getSelectedRows()
        if (!selected.length) {
          alert('âš ï¸ ChÆ°a chá»n dÃ²ng nÃ o Ä‘á»ƒ copy!')
          return
        }

        const text = selected
          .map(
            (r) =>
              `${r.name || ''}\t${r.tree_lv1 || ''}\t${r.tree_lv2 || ''}\t${
                r.tree_lv3 || ''
              }`
          )
          .join('\n')

        navigator.clipboard.writeText(text).then(() => {
          alert('âœ… ÄÃ£ copy ' + selected.length + ' dÃ²ng vÃ o clipboard!')
        })
      })
    </script>
  </body>
</html>
