<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>AG Grid TreeView - Community Edition</title>

    <!-- AG Grid Community -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css"
    /> -->

    <style>
      body {
        margin: 20px;
        font-family: sans-serif;
      }
      #gridContainer {
        height: 600px;
        width: 100%;
      }
      .toolbar {
        margin-bottom: 10px;
      }
      input,
      button {
        padding: 6px 10px;
        margin-right: 10px;
      }
      .tree-indent {
        display: inline-block;
        width: 18px;
      }
      .toggle-btn {
        cursor: pointer;
        font-weight: bold;
        color: #0078d7;
      }

      /* css cho dòn tổng */
      .ag-row-pinned {
        font-weight: bold !important;
        background-color: #f0f0f0 !important;
      }

      /* css xem kẽ dòng */
      .ag-row:nth-child(even) {
        background-color: #f9f9f9; /* màu cho dòng chẵn */
      }

      .ag-row:nth-child(odd) {
        background-color: #ffffff; /* màu cho dòng lẻ */
      }

      /* them cái này để bôi đen được dòng*/
      .ag-cell {
        user-select: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      🔍
      <input type="text" id="globalSearch" placeholder="Tìm kiếm toàn bộ..." />
      <button id="exportExcel">📤 Export CSV</button>
      <button id="copyCellBtn">📋 Copy ô được chọn</button>
      <button id="copyRow">📋 Copy dòng được chọn</button>
    </div>

    <div id="gridContainer" class="ag-theme-alpine"></div>

    <script>
      // ======================
      // 1️⃣ Dữ liệu gốc
      // ======================
      const fullData = [
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis1',
          col1: 'nguyen12',
          col2: 'CNTT1',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis1',
          col1: 'nguyen13',
          col2: 'CNTT2',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis2',
          col1: 'nguyen14',
          col2: 'Backend1',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis2',
          col1: 'dfs dsfds',
          col2: 'đá dfads ',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis2',
          tree_lv4: 'fis22',
          col1: 'nguyen15',
          col2: 'Backend2',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fis',
          tree_lv3: 'fis2',
          tree_lv4: 'fis22',
          col1: 'nguyen19',
          col2: 'Backend2dfs',
          col3: 'abdsf dsfsddfadsfs'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft1',
          col1: 'nguyen151',
          col2: 'Backd23',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft1',
          col1: 'nguyen152',
          col2: 'Bked24',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft1',
          col1: 'dfadsa',
          col2: 'dfdsafds',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft2',
          col1: 'nguyen151',
          col2: 'Backd23',
          col3: 'abdsf dsfsd'
        },
        {
          tree_lv1: 'fpt',
          tree_lv2: 'fsoft',
          tree_lv3: 'fsoft2',
          col1: 'nguyen152',
          col2: 'Bked24',
          col3: 'abdsf dsfsd'
        }
      ]

      // ======================
      // 2️⃣ Hàm tạo dữ liệu tree
      // ======================
      let idCounter = 0
      function buildTree(data) {
        let idCounter = 0
        const rootMap = {}

        for (const row of data) {
          // Lấy tất cả các cấp tree_lv1...tree_lvN
          const treeLevels = Object.keys(row)
            .filter((k) => k.startsWith('tree_lv'))
            .sort((a, b) => {
              const na = parseInt(a.replace('tree_lv', ''))
              const nb = parseInt(b.replace('tree_lv', ''))
              return na - nb
            })

          let currentLevel = rootMap
          let parent = null

          // Duyệt từng cấp
          treeLevels.forEach((key, i) => {
            const value = row[key]
            if (!currentLevel[value]) {
              currentLevel[value] = {
                id: ++idCounter,
                name: value,
                level: i + 1,
                expanded: false,
                leaf: false,
                children: {}
              }
            }
            parent = currentLevel[value]
            currentLevel = parent.children
          })

          // Cấp cuối cùng -> thêm dòng dữ liệu leaf
          parent.children[`leaf_${++idCounter}`] = {
            id: idCounter,
            name: null,
            level: treeLevels.length + 1,
            leaf: true,
            col1: row.col1,
            col2: row.col2,
            col3: row.col3
          }
        }

        return Object.values(rootMap).map((n) => normalizeTree(n))
      }

      function normalizeTree(node) {
        if (node.children && !Array.isArray(node.children)) {
          node.children = Object.values(node.children).map((n) =>
            normalizeTree(n)
          )
        }
        return node
      }

      // ======================
      // 3️⃣ Flatten tree (để hiển thị)
      // ======================
      function flattenTree(nodes) {
        let result = []
        for (const n of nodes) {
          result.push(n)
          if (n.expanded && n.children) {
            result = result.concat(flattenTree(n.children))
          }
        }
        return result
      }

      // ======================
      // 4️⃣ Tree data + Flatten ban đầu
      // ======================
      const nestedData = buildTree(fullData)
      let flatData = flattenTree(nestedData)

      console.log('fullData', fullData)
      console.log('nestedData', nestedData)
      console.log('flatData', flatData)

      // ======================
      // 5️⃣ Cột hiển thị
      // ======================
      const columnDefs = [
        {
          headerName: 'Cấu trúc cây',
          field: 'name',
          flex: 2,
          cellRenderer: (params) => {
            const node = params.data
            if (!node) return ''

            const indent = '<span class="tree-indent"></span>'.repeat(
              node.level - 1
            )
            if (node.leaf) {
              return indent + '📄 ' + (node.name || '')
            } else {
              const symbol = node.expanded ? '➖' : '➕'
              return (
                indent +
                `<span class="toggle-btn" data-id="${node.id}">${symbol}</span> 📁 ` +
                node.name
              )
            }
          }
        },
        { field: 'col1', headerName: 'Cột 1', flex: 1 },
        { field: 'col2', headerName: 'Cột 2', flex: 1 },
        { field: 'col3', headerName: 'Cột 3', flex: 1 }
      ]

      // ======================
      // 6️⃣ Cấu hình AG Grid
      // ======================
      const gridOptions = {
        columnDefs,
        rowData: flatData,
        defaultColDef: {
          filter: true,
          sortable: true,
          resizable: true
        },
        rowSelection: {
          mode: 'multiRow',
          checkboxes: true
        },
        suppressRowClickSelection: false,

        // sự kiện click vào 1 cell
        onCellClicked: (params) => {
          const el = params.event.target
          if (el.classList.contains('toggle-btn')) {
            toggleNode(el.dataset.id)
          } else {
            selectedCellValue = params.value
            console.log('Selected cell value:', selectedCellValue)
            // Bỏ chọn tất cả dòng khác
            gridApi.deselectAll()
            // Chọn dòng hiện tại
            params.node.setSelected(true)
          }
        }
      }

      const eGridDiv = document.getElementById('gridContainer')
      const gridApi = agGrid.createGrid(eGridDiv, gridOptions)

      // ======================
      // 7️⃣ Toggle expand/collapse
      // ======================
      function toggleNode(nodeId) {
        function recursiveToggle(nodes) {
          for (const n of nodes) {
            if (n.id == nodeId) {
              n.expanded = !n.expanded
              break
            }
            if (n.children) recursiveToggle(n.children)
          }
        }
        recursiveToggle(nestedData)
        flatData = flattenTree(nestedData)
        gridApi.setGridOption('rowData', flatData)
      }

      // ======================
      // 8️⃣ Tìm kiếm toàn bộ
      // ======================
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        gridApi.setGridOption('quickFilterText', e.target.value)
      })

      // ======================
      // 9️⃣ Export CSV
      // ======================
      document.getElementById('exportExcel').addEventListener('click', () => {
        gridApi.exportDataAsCsv({
          fileName: 'tree_data.csv'
        })
      })

      // ======================
      // 🔟 Copy dòng chọn
      // ======================
      document.getElementById('copyRow').addEventListener('click', () => {
        const selected = gridApi.getSelectedRows()
        if (!selected.length) {
          alert('⚠️ Chưa chọn dòng nào để copy!')
          return
        }

        const text = selected
          .map(
            (r) =>
              `${r.name || ''}\t${r.col1 || ''}\t${r.col2 || ''}\t${
                r.col3 || ''
              }`
          )
          .join('\n')

        navigator.clipboard.writeText(text).then(() => {
          alert('✅ Đã copy ' + selected.length + ' dòng vào clipboard!')
        })
      })

      document.getElementById('copyCellBtn').addEventListener('click', () => {
        if (selectedCellValue === null) {
          alert('Chưa chọn ô nào để copy!')
          return
        }
        navigator.clipboard.writeText(selectedCellValue.toString()).then(() => {
          alert(`Đã copy: ${selectedCellValue}`)
        })
      })
    </script>
  </body>
</html>
