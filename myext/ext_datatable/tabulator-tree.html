<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Tabulator Tree Table - Advanced Example</title>
    <link
      href="https://unpkg.com/tabulator-tables@6.2.0/dist/css/tabulator.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/tabulator-tables@6.2.0/dist/js/tabulator.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #toolbar {
        margin-bottom: 10px;
      }
      #search {
        padding: 5px;
        width: 240px;
      }
      button {
        padding: 6px 12px;
        margin-left: 6px;
      }
      .tabulator-header-filter input {
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 3px;
      }
    </style>
  </head>
  <body>
    <h2>üè¢ Danh saÃÅch t√¥Ãâ ch∆∞ÃÅc - Tree Table (Tabulator)</h2>
    <div id="toolbar">
      <input id="search" placeholder="üîç TiÃÄm ki√™ÃÅm toaÃÄn b√¥Ã£..." />
      <button id="download-xlsx">üì• Xu√¢ÃÅt Excel</button>
    </div>
    <div id="example-table"></div>

    <script>
      // =========================
      // H√ÄM SINH D·ªÆ LI·ªÜU M·∫™U NHI·ªÄU C·∫§P
      // =========================
      function genData(totalRows = 1000) {
        const baseCompanies = ['FPT', 'Viettel', 'VNPT', 'CMC', 'MobiFone']
        const countries = ['Vietnam', 'Japan', 'Korea', 'USA']
        const data = []
        let id = 1

        // M·ªói company c√≥ nhi·ªÅu Subsidiary, m·ªói Subsidiary c√≥ nhi·ªÅu Team
        baseCompanies.forEach((companyName) => {
          const company = {
            id: id++,
            name: companyName,
            type: 'Company',
            country: 'Vietnam',
            employees: rand(5000, 20000),
            revenue: rand(800, 2500),
            year: rand(1980, 2010),
            _children: []
          }

          const numSubs = rand(2, 5)
          for (let i = 0; i < numSubs; i++) {
            const subName = `${companyName}-Sub${i + 1}`
            const sub = {
              id: id++,
              name: subName,
              type: 'Subsidiary',
              country: pick(countries),
              employees: rand(500, 5000),
              revenue: rand(100, 800),
              year: rand(1990, 2015),
              _children: []
            }

            const numTeams = rand(2, 5)
            for (let j = 0; j < numTeams; j++) {
              sub._children.push({
                id: id++,
                name: `${subName}-Team${j + 1}`,
                type: 'Team',
                country: sub.country,
                employees: rand(50, 500),
                revenue: rand(10, 200),
                year: rand(2000, 2024)
              })
            }

            company._children.push(sub)
          }

          data.push(company)
        })

        // C·∫Øt b·ªõt n·∫øu t·ªïng s·ªë d√≤ng v∆∞·ª£t qu√° gi·ªõi h·∫°n
        const flatCount = countNodes(data)
        if (flatCount > totalRows) {
          return trimTree(data, totalRows)
        }

        return data
      }

      // =========================
      // H√ÄM TI·ªÜN √çCH PH·ª§ TR·ª¢
      // =========================
      function rand(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min
      }

      function pick(arr) {
        return arr[Math.floor(Math.random() * arr.length)]
      }

      function countNodes(nodes) {
        let count = 0
        nodes.forEach((n) => {
          count++
          if (n._children) count += countNodes(n._children)
        })
        return count
      }

      function trimTree(nodes, limit, acc = []) {
        for (const node of nodes) {
          if (acc.length >= limit) break
          const copy = { ...node }
          if (copy._children) {
            copy._children = trimTree(copy._children, limit, acc)
          }
          acc.push(copy)
        }
        return acc
      }

      const tableData = genData(5000)
      console.log(tableData.length)

      // =========================
      // C·∫§U H√åNH B·∫¢NG TABULATOR
      // =========================
      const table = new Tabulator('#example-table', {
        data: tableData,
        layout: 'fitColumns',
        dataTree: true,
        dataTreeStartExpanded: true,
        clipboard: true, // Cho ph√©p copy
        height: '600px',
        placeholder: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
        pagination: 'local',
        paginationSize: 5000,
        paginationSizeSelector: [100, 1000, 5000, 10000], // cho ph√©p ch·ªçn s·ªë d√≤ng
        selectable: true, // ‚úÖ Cho ph√©p ch·ªçn nhi·ªÅu d√≤ng
        clipboard: true, // ‚úÖ Cho ph√©p copy (Ctrl + C)
        clipboardCopyStyled: false, // ‚úÖ Copy ch·ªâ gi√° tr·ªã, kh√¥ng style
        clipboardPasteAction: 'none', // ‚úÖ Kh√¥ng cho paste ƒë√® d·ªØ li·ªáu
        columns: [
          { title: 'STT', formatter: 'rownum', width: 70, hozAlign: 'center' },
          { title: 'T√™n', field: 'name', width: 220, headerFilter: 'input' },
          { title: 'Lo·∫°i', field: 'type', width: 140, headerFilter: 'input' },
          {
            title: 'Qu·ªëc gia',
            field: 'country',
            width: 120,
            headerFilter: 'input'
          },
          {
            title: 'Nh√¢n vi√™n',
            field: 'employees',
            hozAlign: 'right',
            width: 110,
            headerFilter: 'input'
          },
          {
            title: 'Doanh thu (tri·ªáu $)',
            field: 'revenue',
            hozAlign: 'right',
            width: 130,
            headerFilter: 'input'
          },
          {
            title: 'NƒÉm th√†nh l·∫≠p',
            field: 'year',
            hozAlign: 'center',
            width: 110,
            headerFilter: 'input'
          }
        ]
      })

      // =========================
      // T√åM KI·∫æM TO√ÄN C·ª§C
      // =========================
      document.getElementById('search').addEventListener('keyup', function () {
        const val = this.value.toLowerCase()
        table.setFilter([
          [
            { field: 'name', type: 'like', value: val },
            { field: 'type', type: 'like', value: val },
            { field: 'country', type: 'like', value: val }
          ]
        ])
      })

      // =========================
      // EXPORT EXCEL
      // =========================
      document
        .getElementById('download-xlsx')
        .addEventListener('click', function () {
          table.download('xlsx', 'tree-table.xlsx', { sheetName: 'Danh s√°ch' })
        })
    </script>
  </body>
</html>
